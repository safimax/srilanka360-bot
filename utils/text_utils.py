import logging
from aiogram.utils.keyboard import InlineKeyboardBuilder
from aiogram.types import InlineKeyboardMarkup

logger = logging.getLogger(__name__)

# Complete JSON –æ—Ç –ê–ª–µ–∫—Å–∞ —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–º–∏ —Ç–µ–∫—Å—Ç–∞–º–∏
TEXTS = {
    "screens": {
        "welcome_utm": {
            "message": "üèñÔ∏è –≠–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–µ –≤–∏–ª–ª—ã –Ω–∞ –®—Ä–∏-–õ–∞–Ω–∫–µ\n\n–ù–µ–º–µ—Ü–∫–æ–µ –∞–≥–µ–Ω—Ç—Å—Ç–≤–æ ‚Ä¢ 12 –ª–µ—Ç –Ω–∞ –æ—Å—Ç—Ä–æ–≤–µ ‚Ä¢ ‚Ññ1 –≤ –•–∏–∫–∫–∞–¥—É–≤–µ (TripAdvisor)\n\n–ü–æ—á–µ–º—É –º—ã:\nüìå 200+ —ç–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ (–º–Ω–æ–≥–∏–µ –ù–ï —Å–¥–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ Booking)\nüìå –ü—Ä—è–º—ã–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã —Å –≤–ª–∞–¥–µ–ª—å—Ü–∞–º–∏ ‚Äî —ç–∫–æ–Ω–æ–º–∏—è –¥–æ 30%\nüìå –ù–µ–º–µ—Ü–∫–∞—è –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç—å, –æ–ø–ª–∞—Ç–∞ –≤ —Ä—É–±–ª—è—Ö –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞\nüìå –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ –¥–æ–≥–æ–≤–æ—Ä—ã —Å –≤–ª–∞–¥–µ–ª—å—Ü–∞–º–∏ ‚Äî –∑–∞—â–∏—Ç–∞ –æ—Ç ¬´–¥–≤–æ–π–Ω–æ–≥–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è¬ª\nüìå –ü–æ–ª–Ω–æ–µ —Å–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ + —é—Ä–∏–¥–∏—á–µ—Å–∫–∞—è –∑–∞—â–∏—Ç–∞ —Å–¥–µ–ª–∫–∏\nüìå –¢—ã—Å—è—á–∏ –¥–æ–≤–æ–ª—å–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –∑–∞ 12 –ª–µ—Ç —Ä–∞–±–æ—Ç—ã\n\nüõ°Ô∏è –í–∞—à–∏ –≥–∞—Ä–∞–Ω—Ç–∏–∏:\n–õ–∏—á–Ω–∞—è –≤—Å—Ç—Ä–µ—á–∞ —Å –≤–ª–∞–¥–µ–ª—å—Ü–µ–º, –ø–µ—Ä–µ–¥–∞—á–∞ –¥–µ–Ω–µ–≥ –ø–æ–¥ —Ä–∞—Å–ø–∏—Å–∫—É\n–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –¥–æ–≥–æ–≤–æ—Ä –æ—Ç –Ω–∞—à–µ–≥–æ –∏–º–µ–Ω–∏\n–í–ª–∞–¥–µ–ª–µ—Ü –Ω–µ—Å—ë—Ç —Ä–µ–∞–ª—å–Ω—É—é –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –ø–µ—Ä–µ–¥ –Ω–∞–º–∏\n\n–û—Ä–≥–∞–Ω–∏–∑—É–µ–º –æ—Ç–¥—ã—Ö –¥–ª—è —Å–µ–º–µ–π, –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–æ–≤, –π–æ–≥–∞-—Ç—É—Ä–æ–≤, –±–ª–æ–≥–µ—Ä—Å–∫–∏—Ö –ø–æ–µ–∑–¥–æ–∫. –†–∞–±–æ—Ç–∞–µ–º —Å —Ç—É—Ä–∞–≥–µ–Ω—Ç—Å—Ç–≤–∞–º–∏ –ø–æ –≤—Å–µ–º—É –º–∏—Ä—É.\n\nüöÅ –û—Ç–¥—ã—Ö –ø–æ–¥ –∫–ª—é—á: –≤–∏–ª–ª—ã, —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä—ã, —è—Ö—Ç—ã, –≤–µ—Ä—Ç–æ–ª—ë—Ç—ã, —ç–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–µ —Ç—É—Ä—ã\n\n‚ö†Ô∏è –†–µ–∞–ª—å–Ω—ã–µ —Ü–µ–Ω—ã –Ω–∞ —ç–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–µ –≤–∏–ª–ª—ã –æ—Ç $300+ –≤ —Å—É—Ç–∫–∏\n\n–ù–∞—à–∏ —Å–∞–π—Ç—ã: srilanka360.eu | hikkaduwa.com\n\n‚úàÔ∏è –ü—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ—Ç–µ –∂–∏–≤–æ–µ –æ–±—â–µ–Ω–∏–µ? t.me/ychernaya"
        },
        "welcome_channel": {
            "message": "–î–∞–º—ã –∏ –≥–æ—Å–ø–æ–¥–∞, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ 5 –≤–æ–ø—Ä–æ—Å–æ–≤ –±–æ—Ç—É ‚Äî –º—ã –∏—Ö –≤—Å—ë —Ä–∞–≤–Ω–æ –∑–∞–¥–∞–¥–∏–º! üòâ\n\n2 –º–∏–Ω—É—Ç—ã —Å–µ–π—á–∞—Å = —á–∞—Å —Å—ç–∫–æ–Ω–æ–º–ª–µ–Ω–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ + —Ç–æ—á–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –æ—Ç —ç–∫—Å–ø–µ—Ä—Ç–∞.\n\n–ü—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ—Ç–µ —Å—Ä–∞–∑—É –∂–∏–≤–æ–µ –æ–±—â–µ–Ω–∏–µ? t.me/ychernaya"
        },
        "welcome_external": {
            "message": "üèñÔ∏è –≠–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–µ –≤–∏–ª–ª—ã –Ω–∞ –®—Ä–∏-–õ–∞–Ω–∫–µ\n\n–ù–µ–º–µ—Ü–∫–æ–µ –∞–≥–µ–Ω—Ç—Å—Ç–≤–æ ‚Ä¢ 12 –ª–µ—Ç –Ω–∞ –æ—Å—Ç—Ä–æ–≤–µ ‚Ä¢ ‚Ññ1 –≤ –•–∏–∫–∫–∞–¥—É–≤–µ (TripAdvisor)\n\n–ü–æ—á–µ–º—É –º—ã:\nüìå 200+ —ç–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ (–º–Ω–æ–≥–∏–µ –ù–ï —Å–¥–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ Booking)\nüìå –ü—Ä—è–º—ã–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã —Å –≤–ª–∞–¥–µ–ª—å—Ü–∞–º–∏ ‚Äî —ç–∫–æ–Ω–æ–º–∏—è –¥–æ 30%\nüìå –ù–µ–º–µ—Ü–∫–∞—è –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç—å, –æ–ø–ª–∞—Ç–∞ –≤ —Ä—É–±–ª—è—Ö –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞\nüìå –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ –¥–æ–≥–æ–≤–æ—Ä—ã —Å –≤–ª–∞–¥–µ–ª—å—Ü–∞–º–∏ ‚Äî –∑–∞—â–∏—Ç–∞ –æ—Ç ¬´–¥–≤–æ–π–Ω–æ–≥–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è¬ª\nüìå –ü–æ–ª–Ω–æ–µ —Å–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ + —é—Ä–∏–¥–∏—á–µ—Å–∫–∞—è –∑–∞—â–∏—Ç–∞ —Å–¥–µ–ª–∫–∏\nüìå –¢—ã—Å—è—á–∏ –¥–æ–≤–æ–ª—å–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –∑–∞ 12 –ª–µ—Ç —Ä–∞–±–æ—Ç—ã\n\nüõ°Ô∏è –í–∞—à–∏ –≥–∞—Ä–∞–Ω—Ç–∏–∏:\n–õ–∏—á–Ω–∞—è –≤—Å—Ç—Ä–µ—á–∞ —Å –≤–ª–∞–¥–µ–ª—å—Ü–µ–º, –ø–µ—Ä–µ–¥–∞—á–∞ –¥–µ–Ω–µ–≥ –ø–æ–¥ —Ä–∞—Å–ø–∏—Å–∫—É\n–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –¥–æ–≥–æ–≤–æ—Ä –æ—Ç –Ω–∞—à–µ–≥–æ –∏–º–µ–Ω–∏\n–í–ª–∞–¥–µ–ª–µ—Ü –Ω–µ—Å—ë—Ç —Ä–µ–∞–ª—å–Ω—É—é –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –ø–µ—Ä–µ–¥ –Ω–∞–º–∏\n\n–û—Ä–≥–∞–Ω–∏–∑—É–µ–º –æ—Ç–¥—ã—Ö –¥–ª—è —Å–µ–º–µ–π, –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–æ–≤, –π–æ–≥–∞-—Ç—É—Ä–æ–≤, –±–ª–æ–≥–µ—Ä—Å–∫–∏—Ö –ø–æ–µ–∑–¥–æ–∫. –†–∞–±–æ—Ç–∞–µ–º —Å —Ç—É—Ä–∞–≥–µ–Ω—Ç—Å—Ç–≤–∞–º–∏ –ø–æ –≤—Å–µ–º—É –º–∏—Ä—É.\n\nüöÅ –û—Ç–¥—ã—Ö –ø–æ–¥ –∫–ª—é—á: –≤–∏–ª–ª—ã, —Ç—Ä–∞–Ω—Å—Ñ–µ—Ä—ã, —è—Ö—Ç—ã, –≤–µ—Ä—Ç–æ–ª—ë—Ç—ã, —ç–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–µ —Ç—É—Ä—ã\n\n‚ö†Ô∏è –†–µ–∞–ª—å–Ω—ã–µ —Ü–µ–Ω—ã –Ω–∞ —ç–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–µ –≤–∏–ª–ª—ã –æ—Ç $300+ –≤ —Å—É—Ç–∫–∏\n\n–ù–∞—à–∏ —Å–∞–π—Ç—ã: srilanka360.eu | hikkaduwa.com\n\n‚úàÔ∏è –ü—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ—Ç–µ –∂–∏–≤–æ–µ –æ–±—â–µ–Ω–∏–µ? t.me/ychernaya"
        },
        "questions_start": {
            "message": "–î–∞–º—ã –∏ –≥–æ—Å–ø–æ–¥–∞, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ 5 –≤–æ–ø—Ä–æ—Å–æ–≤ –±–æ—Ç—É ‚Äî –º—ã –∏—Ö –≤—Å—ë —Ä–∞–≤–Ω–æ –∑–∞–¥–∞–¥–∏–º! üòâ\n\n2 –º–∏–Ω—É—Ç—ã —Å–µ–π—á–∞—Å = —á–∞—Å —Å—ç–∫–æ–Ω–æ–º–ª–µ–Ω–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ + —Ç–æ—á–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –æ—Ç —ç–∫—Å–ø–µ—Ä—Ç–∞.\n\n–ü—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ—Ç–µ —Å—Ä–∞–∑—É –∂–∏–≤–æ–µ –æ–±—â–µ–Ω–∏–µ? t.me/ychernaya"
        },
        "villa_utm_detected": {
            "message": "üëÄ –í–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç –≤–∏–ª–ª–∞ ‚Ññ{villa_id}! –û—Ç–ª–∏—á–Ω–æ, —É—á—Ç–µ–º —ç—Ç–æ –≤ –ø–æ–¥–±–æ—Ä–µ."
        },
        "villa_fork": {
            "message": "–ï—Å—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è –≤–∏–ª–ª–∞ –Ω–∞ –ø—Ä–∏–º–µ—Ç–µ –∏–ª–∏ —Ö–æ—Ç–∏—Ç–µ, —á—Ç–æ–±—ã –º—ã –ø–æ–¥–æ–±—Ä–∞–ª–∏?"
        },
        "group_type": {
            "message": "–ö–∞–∫–æ–π —É –≤–∞—Å —Å–æ—Å—Ç–∞–≤?"
        }
    },
    "messages": {
        "error_invalid_input": "–Ø –≤–∞—Å –Ω–µ —Å–æ–≤—Å–µ–º –ø–æ–Ω—è–ª. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω –∏–∑ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤.",
        "error_technical": "–ö–∞–∂–µ—Ç—Å—è, —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ —Å /start"
    }
}

def get_text(text_id: str) -> str:
    """–ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –ø–æ ID"""
    keys = text_id.split('.')
    result = TEXTS
    
    for key in keys:
        result = result.get(key, {})
        
    if isinstance(result, str):
        return result
    else:
        logger.warning(f"Missing text for ID: {text_id}")
        return f"[TEXT: {text_id}]"

def get_keyboard(button_texts: list) -> InlineKeyboardMarkup:
    """–°–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –ø–æ —Ç–µ–∫—Å—Ç–∞–º –∫–Ω–æ–ø–æ–∫ - –ë–ï–ó –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫ —ç–∫—Å–ø–µ—Ä—Ç–∞"""
    builder = InlineKeyboardBuilder()
    
    for text in button_texts:
        callback_data = text_to_callback(text)
        builder.button(text=text, callback_data=callback_data)
    
    builder.adjust(1)
    return builder.as_markup()

def text_to_callback(text: str) -> str:
    """–ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –∫–Ω–æ–ø–∫–∏ –≤ callback_data —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –∫–µ–π—Å–∞–º–∏"""
    # –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –∫–µ–π—Å—ã –¥–ª—è –æ—Å–Ω–æ–≤–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫
    if "–≥–æ—Ç–æ–≤ –∫ —ç–∫—Å–∫–ª—é–∑–∏–≤–Ω–æ–º—É –æ—Ç–¥—ã—Ö—É" in text.lower():
        return "–≥–æ—Ç–æ–≤_–∫_—ç–∫—Å–∫–ª—é–∑–∏–≤–Ω–æ–º—É_–æ—Ç–¥—ã—Ö—É"
    elif "–ø–æ–¥–æ–±—Ä–∞—Ç—å –≤–∏–ª–ª—É –ø–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º" in text.lower():
        return "–ø–æ–¥–æ–±—Ä–∞—Ç—å_–≤–∏–ª–ª—É_–ø–æ_–ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º"
    elif "–ø–µ—Ä–µ–π—Ç–∏ –∫ –¥–∞—Ç–∞–º –∏ –¥–µ—Ç–∞–ª—è–º" in text.lower():
        return "–ø–µ—Ä–µ–π—Ç–∏_–∫_–¥–∞—Ç–∞–º_–∏_–¥–µ—Ç–∞–ª—è–º"
    elif "–µ—Å—Ç—å —Å—Å—ã–ª–∫–∞" in text.lower() and "–Ω–æ–º–µ—Ä –≤–∏–ª–ª—ã" in text.lower():
        return "–µ—Å—Ç—å_—Å—Å—ã–ª–∫–∞–Ω–æ–º–µ—Ä_–≤–∏–ª–ª—ã"
    elif "—Ö–æ—á—É –æ–ø–∏—Å–∞—Ç—å –º–µ—á—Ç—É" in text.lower():
        return "—Ö–æ—á—É_–æ–ø–∏—Å–∞—Ç—å_–º–µ—á—Ç—É"
    elif "—Å–µ–º—å—è" in text.lower() and "–∫–æ–º–ø–∞–Ω–∏—è –¥—Ä—É–∑–µ–π" in text.lower():
        return "—Å–µ–º—å—è__–∫–æ–º–ø–∞–Ω–∏—è_–¥—Ä—É–∑–µ–π"
    elif "–º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ" in text.lower() and "–π–æ–≥–∞" in text.lower():
        return "–º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ__–π–æ–≥–∞—Ç—É—Ä"
    
    # –û–±—â–∏–π —Å–ª—É—á–∞–π –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫
    import re
    clean_text = re.sub(r'[^\w\s]', '', text.lower())
    clean_text = clean_text.replace(' ', '_')
    return clean_text[:60]